<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Performance Report - DF Strategic</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/2910/2910791.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/2910/2910791.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn-icons-png.flaticon.com/512/2910/2910791.png">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; overflow-x: hidden; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .val-pos { color: #16a34a; font-weight: 700; }
        .val-neg { color: #dc2626; font-weight: 700; }
        .val-zero { color: #64748b; }

        .dashboard-card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .result-input { font-weight: 600; transition: all 0.2s; padding-left: 1.2rem; }
        .result-input:focus { transform: scale(1.01); outline: none; border-color: #6366f1; }
        
        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0); } .sidebar-closed { transform: translateX(-100%); }
        #cloud-status { transition: all 0.5s; }
        .status-saved { color: #16a34a; } .status-saving { color: #f59e0b; } .status-error { color: #dc2626; }
        .account-item:hover { background-color: #334155; } .account-item.active { background-color: #4f46e5; border-left: 4px solid #818cf8; }
        
        @media print { 
            body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } 
            #print-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 0; }
            #sidebar, #header-main, .no-print { display: none !important; } 
        }
    </style>
</head>
<body class="pb-12">

    <div id="app-loader" class="fixed inset-0 bg-slate-900 z-[9999] flex flex-col items-center justify-center text-white">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mb-4"></div>
        <p class="text-sm animate-pulse">Carregando...</p>
    </div>

    <div id="print-area" class="hidden"></div>
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden backdrop-blur-sm transition-opacity no-print"></div>
    
    <div id="sidebar" class="fixed inset-y-0 left-0 w-80 bg-slate-900 text-white z-50 sidebar-closed shadow-2xl flex flex-col no-print">
        <div class="p-5 border-b border-slate-700 flex justify-between items-center">
            <div><h2 class="font-bold text-xl">Contas</h2><p class="text-xs text-slate-400">Gerenciamento</p></div>
            <button id="close-sidebar" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-2" id="account-list"></div>
        <div class="p-4 border-t border-slate-700 bg-slate-800">
            <button id="add-account-btn" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-sm font-bold flex items-center justify-center gap-2 transition"><i data-lucide="plus-circle" class="w-4 h-4"></i> Nova Conta</button>
        </div>
    </div>

    <div id="header-main" class="bg-slate-900 text-white py-2 px-4 shadow-md sticky top-0 z-40 flex justify-between items-center no-print">
        <div class="flex items-center gap-3">
            <button id="open-sidebar" class="p-1 hover:bg-slate-700 rounded text-slate-300"><i data-lucide="menu" class="w-6 h-6"></i></button>
            <div class="flex items-center gap-2">
                <div class="bg-indigo-500 p-1 rounded"><i data-lucide="trending-up" class="w-4 h-4"></i></div>
                <span class="font-bold tracking-wide text-sm md:text-base">Performance Report <span class="font-normal text-slate-400">| DF Strategic</span></span>
            </div>
        </div>
        <div class="flex items-center gap-3"><div id="cloud-status" class="text-xs flex items-center gap-1 text-slate-400 font-medium"><i data-lucide="cloud" class="w-3 h-3"></i> <span id="status-text">Conectando...</span></div></div>
    </div>

    <div class="bg-white border-b border-slate-200 shadow-sm sticky top-10 z-30 no-print">
        <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center gap-3">
            <div><h1 id="active-account-name" class="font-bold text-lg leading-none text-slate-800">Carregando...</h1><p class="text-xs text-slate-500 flex items-center gap-1 mt-1"><span id="active-account-config">--</span></p></div>
            <div class="flex gap-2 text-sm">
                <select id="config-size" class="bg-slate-50 border border-slate-300 rounded px-2 py-1 text-slate-700 text-xs outline-none"><option value="25k">25k</option><option value="50k">50k</option><option value="75k">75k</option><option value="100k">100k</option><option value="150k">150k</option><option value="250k">250k</option><option value="300k">300k</option></select>
                <select id="config-month" class="bg-slate-50 border border-slate-300 rounded px-2 py-1 text-slate-700 text-xs outline-none"><option value="1">M√™s 1-3</option><option value="4">M√™s 4+</option></select>
                <button id="rename-account-btn" class="p-1.5 bg-slate-100 hover:bg-indigo-100 text-slate-500 hover:text-indigo-600 rounded transition"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6 space-y-6 no-print">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 dashboard-card p-6 bg-white border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="bar-chart" class="w-4 h-4 text-indigo-600"></i> Evolu√ß√£o de Saldo</h3>
                </div>
                <div class="relative h-64 w-full">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>

            <div class="lg:col-span-1 dashboard-card p-6 bg-slate-50 border border-slate-200">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="filter" class="w-4 h-4 text-indigo-600"></i> An√°lise por Per√≠odo</h3>
                
                <div class="flex gap-2 mb-4">
                    <input type="date" id="filter-start" class="w-full text-xs p-2 border rounded">
                    <input type="date" id="filter-end" class="w-full text-xs p-2 border rounded">
                    <button onclick="filterReport()" class="bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700"><i data-lucide="search" class="w-4 h-4"></i></button>
                </div>

                <div class="space-y-3 text-sm">
                    <div class="flex justify-between border-b border-slate-200 pb-2">
                        <span class="text-slate-500">Resultado Per√≠odo</span>
                        <span id="custom-result" class="font-bold text-slate-800">--</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-200 pb-2">
                        <span class="text-slate-500">Taxa de Acerto</span>
                        <span id="custom-winrate" class="font-bold text-indigo-600">--</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-200 pb-2">
                        <span class="text-slate-500">Melhor Dia</span>
                        <span id="custom-best" class="font-bold text-green-600">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500">Pior Dia</span>
                        <span id="custom-worst" class="font-bold text-red-600">--</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mt-4">
                     <button onclick="shareReport()" class="w-full py-2 bg-green-50 hover:bg-green-100 text-green-700 border border-green-200 rounded text-xs font-bold flex justify-center items-center gap-1"><i data-lucide="share-2" class="w-3 h-3"></i> Zap/Share</button>
                     <button onclick="printReport()" class="w-full py-2 bg-white border border-slate-300 text-slate-600 rounded text-xs font-bold hover:bg-slate-50 flex justify-center items-center gap-1"><i data-lucide="printer" class="w-3 h-3"></i> PDF</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="dashboard-card p-4 border-l-4 border-l-indigo-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Saldo Atual (Equity)</p>
                <h2 id="current-equity" class="text-3xl font-extrabold text-slate-800 mt-1">$0.00</h2>
                <p id="equity-diff" class="text-xs font-medium mt-1 text-gray-500">--</p>
            </div>
            <div class="dashboard-card p-4 border-l-4 border-l-green-500 relative overflow-hidden">
                <div class="flex justify-between items-start"><div><p class="text-xs font-bold text-green-900 uppercase flex items-center gap-1"><i data-lucide="target" class="w-3 h-3"></i> Teto 30% (Hoje)</p><h2 id="gain-cap" class="text-2xl font-bold text-green-600 mt-1">$0.00</h2></div></div>
                <p class="text-xs text-gray-500 mt-1">Limite sugerido p/ consist√™ncia.</p>
            </div>
             <div class="dashboard-card p-4 border-l-4 border-l-yellow-500">
                <p class="text-xs font-bold text-yellow-700 uppercase">Saque</p>
                <div class="flex items-center justify-between mt-2"><span id="payout-status" class="text-lg font-bold text-slate-700">Analisando...</span></div>
                <p id="payout-msg" class="text-xs text-slate-400 mt-1">--</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                    <button id="prev-month" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="chevron-left"></i></button>
                    <h2 id="calendar-title" class="text-xl font-bold text-slate-700">--</h2>
                    <button id="next-month" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="chevron-right"></i></button>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs">
                                <tr><th class="px-4 py-3">Data</th><th class="px-4 py-3 w-32">Resultado</th><th class="px-4 py-3">Notas</th><th class="px-4 py-3 text-center w-10" title="Folga"><i data-lucide="coffee" class="w-3 h-3 mx-auto"></i></th><th class="px-4 py-3 text-center w-10" title="Sacado"><i data-lucide="check-circle-2" class="w-3 h-3 mx-auto text-green-600"></i></th></tr>
                            </thead>
                            <tbody id="calendar-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-4">
                <div class="dashboard-card p-5">
                    <h3 class="font-bold text-slate-800 mb-4 text-sm uppercase tracking-wide flex items-center gap-2"><i data-lucide="calendar-check" class="w-4 h-4"></i> Performance (Ciclos Atuais)</h3>
                    <div class="space-y-3 text-sm">
                        
                        <div class="flex justify-between items-center border-b border-slate-50 pb-1">
                            <span class="text-slate-500 font-medium">Mensal (1 a 31)</span>
                            <span id="stats-month" class="font-bold text-slate-800">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-slate-50 pb-1">
                            <span class="text-slate-500">Ciclo 10 a 10</span>
                            <span id="stats-c10" class="font-bold text-slate-700">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-slate-50 pb-1">
                            <span class="text-slate-500">Ciclo 15 a 15</span>
                            <span id="stats-c15" class="font-bold text-slate-700">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-slate-50 pb-1">
                            <span class="text-slate-500">Ciclo 20 a 20</span>
                            <span id="stats-c20" class="font-bold text-slate-700">$0.00</span>
                        </div>
                        
                        <div class="mt-4 pt-2 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs font-semibold text-indigo-400 uppercase">M√©dia Di√°ria (10d)</span><span id="stats-avg" class="font-bold text-indigo-600">$0.00</span></div>
                            <div class="flex justify-between items-center"><span class="text-xs font-bold text-indigo-800 uppercase">Proje√ß√£o (22 dias)</span><span id="stats-proj" class="font-bold text-lg text-indigo-700">$0.00</span></div>
                        </div>
                    </div>
                    <div id="weekly-list" class="mt-4 space-y-1 text-xs text-slate-500"></div>
                </div>

                <div class="dashboard-card p-5 bg-slate-900 text-white border-none">
                    <h3 class="font-bold text-sm mb-3 text-slate-200">Regras & Saque</h3>
                    <div class="mb-3"><div class="flex justify-between text-xs mb-1 text-slate-400"><span>Rede Seguran√ßa</span><span id="safety-target">--</span></div><div class="bg-slate-700 h-2 rounded-full overflow-hidden"><div id="safety-bar" class="bg-green-500 h-full transition-all" style="width: 0%"></div></div></div>
                    <div class="mb-4"><div class="flex justify-between text-xs mb-1 text-slate-400"><span>Consist√™ncia (Max 30%)</span><span id="cons-ratio">0%</span></div><div class="bg-slate-700 h-2 rounded-full overflow-hidden"><div id="cons-bar" class="bg-indigo-500 h-full transition-all" style="width: 0%"></div></div></div>
                    <button id="btn-payout" disabled class="w-full py-2 rounded bg-slate-700 text-slate-500 font-bold text-sm flex justify-center items-center gap-2"><i data-lucide="lock" class="w-4 h-4"></i> Bloqueado</button>
                </div>

                <div class="dashboard-card p-5">
                    <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-800 text-sm flex items-center gap-2"><i data-lucide="history" class="w-4 h-4"></i> Hist√≥rico</h3></div>
                    <div class="max-h-40 overflow-y-auto text-sm space-y-2" id="payout-history"><p class="text-xs text-slate-400 italic">Vazio.</p></div>
                    <div class="pt-2 mt-2 border-t border-slate-100 flex justify-between text-xs font-bold"><span>Total Sacado:</span><span id="total-withdrawn" class="text-green-600">$0.00</span></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCu5pQrMnrpSj45lto_GXKx9xIWq2kyDjg",
            authDomain: "df-apex-manager.firebaseapp.com",
            projectId: "df-apex-manager",
            storageBucket: "df-apex-manager.firebasestorage.app",
            messagingSenderId: "761037562102",
            appId: "1:761037562102:web:a7622dca93a157dc21ccd7"
        };

        let db;
        let chartInstance = null; 
        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); console.log("Firebase OK"); } catch (e) { console.error(e); }

        const RULES = {
            '25k': { start: 25000, drawdown: 1500, safetyThreshold: 26600, payouts: [1500, 1500, 1500] },
            '50k': { start: 50000, drawdown: 2500, safetyThreshold: 52600, payouts: [2000, 2000, 2000] },
            '75k': { start: 75000, drawdown: 2750, safetyThreshold: 77850, payouts: [2250, 2250, 2250] },
            '100k': { start: 100000, drawdown: 3000, safetyThreshold: 103100, payouts: [2500, 2500, 2500] },
            '150k': { start: 150000, drawdown: 5000, safetyThreshold: 155100, payouts: [2750, 2750, 2750] },
            '250k': { start: 250000, drawdown: 6500, safetyThreshold: 256600, payouts: [3000, 3000, 3000] },
            '300k': { start: 300000, drawdown: 7500, safetyThreshold: 307600, payouts: [3000, 3000, 3000] }
        };

        let store = { activeId: null, date: new Date(), accounts: {} };
        let saveTimeout;

        // ELEMENTS
        const els = { 
            sidebar: document.getElementById('sidebar'), backdrop: document.getElementById('sidebar-backdrop'), accList: document.getElementById('account-list'), 
            activeName: document.getElementById('active-account-name'), activeConfig: document.getElementById('active-account-config'), 
            inpSize: document.getElementById('config-size'), inpMonth: document.getElementById('config-month'), 
            equity: document.getElementById('current-equity'), equityDiff: document.getElementById('equity-diff'), 
            gainCap: document.getElementById('gain-cap'), 
            
            statsMonth: document.getElementById('stats-month'),
            statsC10: document.getElementById('stats-c10'),
            statsC15: document.getElementById('stats-c15'),
            statsC20: document.getElementById('stats-c20'),
            
            statsAvg: document.getElementById('stats-avg'), statsProj: document.getElementById('stats-proj'),
            weeklyList: document.getElementById('weekly-list'), 
            calendarTitle: document.getElementById('calendar-title'), calendarBody: document.getElementById('calendar-body'), 
            safetyBar: document.getElementById('safety-bar'), safetyTarget: document.getElementById('safety-target'), 
            consBar: document.getElementById('cons-bar'), consRatio: document.getElementById('cons-ratio'), 
            payoutStatus: document.getElementById('payout-status'), payoutMsg: document.getElementById('payout-msg'), btnPayout: document.getElementById('btn-payout'), 
            payoutHistory: document.getElementById('payout-history'), totalWithdrawn: document.getElementById('total-withdrawn'), 
            printArea: document.getElementById('print-area'), loader: document.getElementById('app-loader'), cloudStatus: document.getElementById('status-text'),
            
            customResult: document.getElementById('custom-result'), customWinrate: document.getElementById('custom-winrate'),
            customBest: document.getElementById('custom-best'), customWorst: document.getElementById('custom-worst'),
            filterStart: document.getElementById('filter-start'), filterEnd: document.getElementById('filter-end')
        };

        function toggleSidebar() { const isOpen=!els.sidebar.classList.contains('sidebar-closed'); if(isOpen){els.sidebar.classList.add('sidebar-closed');els.sidebar.classList.remove('sidebar-open');els.backdrop.classList.add('hidden');}else{els.sidebar.classList.remove('sidebar-closed');els.sidebar.classList.add('sidebar-open');els.backdrop.classList.remove('hidden');} }
        function renderSidebar() { els.accList.innerHTML=''; Object.values(store.accounts).forEach(acc=>{ const stats=calculateStats(acc); const div=document.createElement('div'); div.className=`account-item p-3 rounded-lg cursor-pointer transition-colors mb-2 ${acc.id===store.activeId?'active':'bg-slate-800'}`; div.onclick=()=>{loadAccount(acc.id);toggleSidebar();}; div.innerHTML=`<div class="flex justify-between items-center"><span class="font-bold text-sm text-slate-200">${acc.name}</span><span class="text-xs text-indigo-300 font-mono">${acc.size}</span></div><div class="flex justify-between items-center mt-1"><span class="text-xs text-slate-400">Saldo:</span><span class="text-xs font-bold ${stats.currentEquity>=RULES[acc.size].start?'text-green-400':'text-red-400'}">${formatCurrency(stats.currentEquity)}</span></div>`; els.accList.appendChild(div); }); }
        function formatCurrency(v){return v.toLocaleString('en-US',{style:'currency',currency:'USD'});}
        function getActive(){return store.accounts[store.activeId];}
        
        function calculateStats(acc) { 
            const rules=RULES[acc.size]; let tp=0; let dt=0; let pe=rules.start; 
            let md=-Infinity; let mDate=null; 
            let wd=Infinity; let wDate=null;
            let wins=0; let losses=0;

            const keys=Object.keys(acc.data).sort(); let re=rules.start; 
            keys.forEach(d=>{ 
                const e=acc.data[d]; const val = e.val || 0; 
                if(val!==0 && !e.holiday){ 
                    tp+=val; dt++; re+=val; 
                    if(re>pe)pe=re; 
                    if(val>md) { md=val; mDate=d; } 
                    if(val<wd) { wd=val; wDate=d; }
                    if(val>0) wins++; else losses++;
                } 
            }); 
            const w=(acc.payouts||[]).reduce((s,p)=>s+p.amount,0); 
            return {currentEquity:rules.start+tp-w, totalProfit:tp, daysTraded:dt, peakEquity:pe, maxDay:md===-Infinity?0:md, maxDate:mDate, minDay:wd===Infinity?0:wd, minDate:wDate, wins, losses}; 
        }

        window.filterReport = function() {
            const start = els.filterStart.value;
            const end = els.filterEnd.value;
            if(!start || !end) { alert("Selecione data de in√≠cio e fim"); return; }
            
            const acc = getActive();
            let sum = 0; let wins = 0; let count = 0; let best = -Infinity; let worst = Infinity;
            let chartLabels = []; let chartData = []; let cumSum = 0;
            
            Object.keys(acc.data).sort().forEach(iso => {
                if(iso >= start && iso <= end) {
                    const val = acc.data[iso].val || 0;
                    if(val !== 0 && !acc.data[iso].holiday) {
                        sum += val; count++;
                        if(val > 0) wins++;
                        if(val > best) best = val;
                        if(val < worst) worst = val;
                        
                        cumSum += val;
                        chartLabels.push(new Date(iso).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}));
                        chartData.push(cumSum);
                    }
                }
            });
            
            els.customResult.textContent = formatCurrency(sum);
            els.customResult.className = sum >= 0 ? "font-bold text-green-600" : "font-bold text-red-600";
            els.customWinrate.textContent = count > 0 ? ((wins/count)*100).toFixed(0)+"%" : "0%";
            els.customBest.textContent = best > -Infinity ? formatCurrency(best) : "--";
            els.customWorst.textContent = worst < Infinity ? formatCurrency(worst) : "--";
            
            updateChart(chartLabels, chartData);
        }

        function updateChart(labels, data) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Lucro Acumulado',
                        data: data,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#4f46e5',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { y: { grid: { color: '#f3f4f6' } }, x: { grid: { display: false } } }
                }
            });
        }
        
        function getTradedDays(acc) { const allDates = Object.keys(acc.data); return allDates.filter(iso => { const entry = acc.data[iso]; const val = entry.val || 0; return val !== 0 && !entry.holiday; }).sort((a, b) => new Date(b) - new Date(a)); }
        function calcProjection(acc) { 
            const tradedDays = getTradedDays(acc); 
            const last10Days = tradedDays.slice(0, 10); 
            let sum = 0; 
            last10Days.forEach(iso => sum += (acc.data[iso].val || 0)); 
            const count = last10Days.length; 
            const avg = count > 0 ? sum / count : 0; 
            const projection = avg * 22; 
            return { avg, projection }; 
        }
        
        function getMonthlyDataFixed(acc) { const y = store.date.getFullYear(); const m = store.date.getMonth(); const daysInMonth = new Date(y, m+1, 0).getDate(); let weeks = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }; let total = 0; for(let d=1; d<=daysInMonth; d++) { const date = new Date(y, m, d); const iso = date.toISOString().split('T')[0]; const entry = acc.data[iso]; const weekIndex = Math.ceil(d / 7); if(entry && !entry.holiday) { weeks[weekIndex] += (entry.val || 0); total += (entry.val || 0); } } let html = ''; for(let i=1; i<=5; i++) { const startDay = (i - 1) * 7 + 1; if (startDay > daysInMonth) continue; const label = `Semana ${i} (${startDay < 10 ? '0'+startDay : startDay}/${m+1 < 10 ? '0'+(m+1) : m+1})`; const val = weeks[i]; html += `<div class="flex justify-between border-b border-slate-50 pb-1 last:border-0 text-xs"><span class="text-slate-500">${label}</span><span class="font-bold ${val >= 0 ? 'val-pos' : 'val-neg'}">${formatCurrency(val)}</span></div>`; } if(!html) html = '<span class="italic text-xs text-slate-400">Sem dados</span>'; return { total, html }; }

        function calcCycle(acc, startDay) {
            const today = new Date();
            let startDate = new Date(today);
            if (today.getDate() < startDay) { startDate.setMonth(startDate.getMonth() - 1); }
            startDate.setDate(startDay); startDate.setHours(0,0,0,0);
            let sum = 0;
            Object.keys(acc.data).forEach(iso => {
                const d = new Date(iso); d.setHours(0,0,0,0);
                if (d >= startDate) {
                     const entry = acc.data[iso]; const val = entry.val || 0;
                     if(val !== 0 && !entry.holiday) sum += val;
                }
            });
            return sum;
        }

        function checkPayoutStatus(acc,stats,rules,ratio,dist){ const d=stats.daysTraded>=8; const s=dist<=0; const c=ratio<=30; let avail=0; if(d&&s&&c) avail=Math.min(stats.currentEquity-rules.safetyThreshold, acc.monthType<=3?rules.payouts[0]:999999); if(avail>=500){ els.payoutStatus.textContent="Dispon√≠vel"; els.payoutStatus.className="text-lg font-bold text-green-600"; els.payoutMsg.textContent=`Pode sacar ${formatCurrency(avail)}`; els.btnPayout.disabled=false; els.btnPayout.className="w-full py-2 rounded bg-green-600 hover:bg-green-700 text-white font-bold text-sm shadow transition flex justify-center items-center gap-2"; els.btnPayout.innerHTML=`<i data-lucide="dollar-sign" class="w-4 h-4"></i> Sacar ${formatCurrency(avail)}`; els.btnPayout.onclick=()=>executePayout(avail); } else { els.payoutStatus.textContent="Em Progresso"; els.payoutStatus.className="text-lg font-bold text-slate-700"; els.payoutMsg.textContent=!s?"Falta atingir a rede.":(!d?`Faltam ${8-stats.daysTraded} dias.`:(!c?"Ajustar consist√™ncia.":"M√≠nimo $500 excedente.")); els.btnPayout.disabled=true; els.btnPayout.className="w-full py-2 rounded bg-slate-700 text-slate-500 font-bold text-sm cursor-not-allowed flex justify-center items-center gap-2"; els.btnPayout.innerHTML=`<i data-lucide="lock" class="w-4 h-4"></i> Indispon√≠vel`; } }
        function renderPayoutHistory(acc){ els.payoutHistory.innerHTML='';let t=0; if(!acc.payouts||!acc.payouts.length) els.payoutHistory.innerHTML='<p class="text-xs text-slate-400 italic">Vazio.</p>'; else { acc.payouts.slice().reverse().forEach(p=>{ t+=p.amount; const d=document.createElement('div'); d.className="border-b border-slate-50 pb-2 mb-2 last:border-0"; d.innerHTML=`<div class="flex justify-between items-center"><span class="text-xs text-slate-500">${new Date(p.date).toLocaleDateString()}</span><span class="font-bold text-green-600">${formatCurrency(p.amount)}</span></div>${p.note ? `<div class="text-xs text-slate-400 mt-0.5 italic">Ref: ${p.note}</div>` : ''}`; els.payoutHistory.appendChild(d); }); } els.totalWithdrawn.textContent=formatCurrency(t); }
        
        // --- PRINT & SHARE OPTIMIZED ---
        function printReport() { 
            const acc = getActive(); 
            const stats = calculateStats(acc);
            const mData = getMonthlyDataFixed(acc);
            
            // Gather filtered data if available, else default
            const start = els.filterStart.value ? new Date(els.filterStart.value).toLocaleDateString() : "In√≠cio";
            const end = els.filterEnd.value ? new Date(els.filterEnd.value).toLocaleDateString() : "Hoje";
            const res = els.customResult.textContent;
            
            // Generate Chart Image
            let chartImg = "";
            if(chartInstance) { chartImg = chartInstance.toBase64Image(); }
            
            let html = `
            <div style="font-family:sans-serif;width:100%;padding:20px;box-sizing:border-box;">
                <div style="text-align:center;margin-bottom:20px;">
                    <h1 style="color:#0f172a;margin:0;font-size:24px;">Performance Report</h1>
                    <p style="color:#64748b;margin:5px 0 0;">DF Strategic | ${acc.name}</p>
                </div>
                
                ${chartImg ? `<div style="width:100%;height:300px;margin-bottom:20px;border:1px solid #eee;border-radius:8px;overflow:hidden;display:flex;justify-content:center;"><img src="${chartImg}" style="max-width:100%;max-height:100%;object-fit:contain;"></div>` : ''}

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                    <div style="background:#f8fafc;padding:15px;border-radius:8px;border:1px solid #eee;">
                        <h3 style="margin-top:0;font-size:14px;color:#0f172a;">Per√≠odo (${start} - ${end})</h3>
                        <div style="font-size:12px;color:#64748b;margin-bottom:5px;">RESULTADO</div>
                        <div style="font-size:20px;font-weight:bold;color:${res.includes('-')?'#dc2626':'#16a34a'}">${res}</div>
                        <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:12px;">
                            <span>Win Rate: <strong style="color:#4f46e5">${els.customWinrate.textContent}</strong></span>
                            <span>Melhor Dia: <strong style="color:#16a34a">${els.customBest.textContent}</strong></span>
                        </div>
                    </div>
                    <div style="background:#fff;padding:0;border:none;">
                         <table style="width:100%;border-collapse:collapse;font-size:12px;">
                            <tr style="background:#f1f5f9;"><th style="padding:8px;text-align:left;">Ciclo</th><th style="padding:8px;text-align:right;">Total</th></tr>
                            <tr style="border-bottom:1px solid #eee;"><td style="padding:8px;">Mensal</td><td style="padding:8px;text-align:right;font-weight:bold;">${formatCurrency(mData.total)}</td></tr>
                            <tr style="border-bottom:1px solid #eee;"><td style="padding:8px;">10-10</td><td style="padding:8px;text-align:right;">${formatCurrency(calcCycle(acc,10))}</td></tr>
                            <tr style="border-bottom:1px solid #eee;"><td style="padding:8px;">15-15</td><td style="padding:8px;text-align:right;">${formatCurrency(calcCycle(acc,15))}</td></tr>
                            <tr><td style="padding:8px;">20-20</td><td style="padding:8px;text-align:right;">${formatCurrency(calcCycle(acc,20))}</td></tr>
                        </table>
                    </div>
                </div>
                
                <p style="font-size:9px;color:#ccc;text-align:center;margin-top:20px;">Gerado em ${new Date().toLocaleDateString()}</p>
            </div>`;

            const win = window.open('', '_blank'); 
            win.document.write(`<html><head><title>Relat√≥rio</title><style>@page { size: A4 portrait; margin: 10mm; } body { margin: 0; }</style></head><body>${html}</body></html>`); 
            win.document.close(); 
            setTimeout(() => win.print(), 800); 
        }

        function shareReport() {
            const acc = getActive(); 
            const res = els.customResult.textContent;
            const period = els.filterStart.value ? `(${new Date(els.filterStart.value).toLocaleDateString()} - ${new Date(els.filterEnd.value).toLocaleDateString()})` : "(Geral)";
            
            const text = `*Performance Report - DF Strategic* üìä\n${period}\n\n` +
                         `*Resultado:* ${res}\n` +
                         `*Win Rate:* ${els.customWinrate.textContent}\n` +
                         `*Melhor Dia:* ${els.customBest.textContent}\n\n` +
                         `*Ciclos Atuais:*\n` +
                         `Mensal: ${formatCurrency(getMonthlyDataFixed(acc).total)}\n` +
                         `10-10: ${formatCurrency(calcCycle(acc, 10))}\n` +
                         `15-15: ${formatCurrency(calcCycle(acc, 15))}`;
            
            if (navigator.share) { navigator.share({ title: 'Performance Report', text: text }).catch(console.error); } 
            else { navigator.clipboard.writeText(text).then(() => alert("Resumo copiado!")); }
        }

        function changeMonth(d){store.date.setMonth(store.date.getMonth()+d);renderDashboard();} 
        
        function updateData(iso, field, val) {
            const acc = getActive();
            if (!acc.data[iso]) acc.data[iso] = {};
            if (field === 'val') val = parseFloat(val) || 0;
            acc.data[iso][field] = val;
            renderDashboard();
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveToCloud, 1000); 
        }

        function createAccount() { const name = prompt("Nome:"); if(!name)return; const id = 'acc_' + Date.now(); store.accounts[id] = { id, name, size: '50k', monthType: 1, data: {}, payouts: [] }; saveToCloud(); renderSidebar(); loadAccount(id); toggleSidebar(); }
        function renameAccount() { const acc = getActive(); const newName = prompt("Nome:", acc.name); if(newName){ acc.name = newName; saveToCloud(); renderSidebar(); els.activeName.textContent = newName; } }
        function loadAccount(id) { if (!store.accounts[id]) id = Object.keys(store.accounts)[0]; store.activeId = id; const acc = store.accounts[id]; els.activeName.textContent = acc.name; els.activeConfig.textContent = `${acc.size} ‚Ä¢ M√™s ${acc.monthType}`; els.inpSize.value = acc.size; els.inpMonth.value = acc.monthType; renderSidebar(); renderDashboard(); }
        function updateConfig() { const acc = getActive(); acc.size = els.inpSize.value; acc.monthType = parseInt(els.inpMonth.value); saveToCloud(); els.activeConfig.textContent = `${acc.size} ‚Ä¢ M√™s ${acc.monthType}`; renderDashboard(); }
        function executePayout(v) { const note = prompt(`Valor: ${formatCurrency(v)}\n\nRef (Opcional):`); if(note === null) return; const acc = getActive(); acc.payouts.push({date:new Date().toISOString(), amount:v, note: note||''}); saveToCloud(); renderDashboard(); alert("Saque salvo!"); }

        function renderDashboard() { 
            const acc=getActive(); const rules=RULES[acc.size]; const stats=calculateStats(acc); 
            if(els.equity) els.equity.textContent=formatCurrency(stats.currentEquity); 
            if(els.equityDiff) {
                const diff=stats.currentEquity-rules.start; 
                els.equityDiff.textContent=`Lucro: ${formatCurrency(diff)}`; 
                els.equityDiff.className=diff>=0?"text-xs font-medium mt-1 text-green-600":"text-xs font-medium mt-1 text-red-500"; 
            }
            
            let gainCap=(stats.totalProfit>0)?(stats.totalProfit*0.30)/0.70:0; 
            if(els.gainCap) els.gainCap.textContent=gainCap>0?formatCurrency(gainCap):"Fazer Gordura"; 
            
            renderCalendar(acc); 
            
            if(els.statsMonth) els.statsMonth.textContent = formatCurrency(getMonthlyDataFixed(acc).total); 
            if(els.statsC10) els.statsC10.textContent = formatCurrency(calcCycle(acc, 10)); 
            if(els.statsC15) els.statsC15.textContent = formatCurrency(calcCycle(acc, 15)); 
            if(els.statsC20) els.statsC20.textContent = formatCurrency(calcCycle(acc, 20)); 

            const proj = calcProjection(acc); 
            if(els.statsAvg) els.statsAvg.textContent = formatCurrency(proj.avg); 
            if(els.statsProj) els.statsProj.textContent = formatCurrency(proj.projection);
            
            // AUTO FILTER IF EMPTY
            if(!els.filterStart.value) {
                const now = new Date();
                els.filterStart.value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                els.filterEnd.value = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
            }
            filterReport();
            
            const mData=getMonthlyDataFixed(acc); 
            if(els.weeklyList) els.weeklyList.innerHTML=mData.html; 
            
            if(els.safetyTarget) els.safetyTarget.textContent=formatCurrency(rules.safetyThreshold); 
            const distSafety=rules.safetyThreshold-stats.currentEquity; 
            if(els.safetyBar) {
                if(distSafety<=0){els.safetyBar.style.width='100%';els.safetyBar.classList.replace('bg-indigo-500','bg-green-500');} 
                else {const pct=Math.max(0,Math.min(100,((stats.currentEquity-rules.start)/(rules.safetyThreshold-rules.start))*100));els.safetyBar.style.width=`${pct}%`;} 
            }
            
            const ratio=stats.totalProfit>0?(stats.maxDay/stats.totalProfit)*100:0; 
            if(els.consRatio) els.consRatio.textContent=`${ratio.toFixed(1)}%`; 
            if(els.consBar) {
                els.consBar.style.width=`${Math.min(100,ratio)}%`; 
                els.consBar.className=ratio>30?"h-full bg-red-500":"h-full bg-indigo-500"; 
            }
            
            checkPayoutStatus(acc,stats,rules,ratio,distSafety); 
            renderPayoutHistory(acc); 
            lucide.createIcons(); 
        }

        // --- CALENDAR RENDER (WITH COLORS & TEXT INPUT) ---
        function renderCalendar(acc) { 
            const y=store.date.getFullYear(); const m=store.date.getMonth(); els.calendarTitle.textContent=`${['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'][m]} ${y}`; els.calendarBody.innerHTML=''; const daysInMonth=new Date(y,m+1,0).getDate(); 
            for(let d=1;d<=daysInMonth;d++){ 
                const date=new Date(y,m,d); const iso=date.toISOString().split('T')[0]; const entry=acc.data[iso]||{val:0,note:'',holiday:false,withdrawn:false}; const isW=date.getDay()===0||date.getDay()===6; const tr=document.createElement('tr'); if(isW)tr.className="bg-slate-50 opacity-50"; if(entry.withdrawn)tr.className="bg-green-50"; 
                
                let colorClass = 'val-zero';
                if(entry.val > 0) colorClass = 'val-pos';
                else if(entry.val < 0) colorClass = 'val-neg';

                tr.innerHTML=`
                    <td class="px-4 py-2 font-medium text-slate-600">${d}</td>
                    <td class="px-4 py-2 relative">
                        <div class="relative w-full">
                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400 text-sm font-bold z-10 pointer-events-none select-none">$</span>
                            <input type="text" inputmode="decimal" class="result-input w-full pl-6 pr-2 py-1 bg-transparent border-b border-transparent focus:border-indigo-500 ${colorClass}" value="${entry.val!==0?entry.val.toFixed(2):''}" placeholder="0.00" onblur="updateData('${iso}','val',this.value)" ${isW?'disabled':''}>
                        </div>
                    </td>
                    <td class="px-4 py-2"><input type="text" class="w-full bg-transparent text-xs" value="${entry.note||''}" placeholder="..." onchange="updateData('${iso}','note',this.value)" ${isW?'disabled':''}></td>
                    <td class="px-4 py-2 text-center"><input type="checkbox" ${entry.holiday?'checked':''} onchange="updateData('${iso}','holiday',this.checked)" ${isW?'disabled':''} title="Feriado"></td>
                    <td class="px-4 py-2 text-center"><input type="checkbox" class="accent-green-600" ${entry.withdrawn?'checked':''} onchange="updateData('${iso}','withdrawn',this.checked)" ${isW?'disabled':''} title="Saque"></td>
                `;
                els.calendarBody.appendChild(tr);
            } 
        }

        // --- INIT ---
        function setStatus(state) {
            const text = document.getElementById('status-text');
            if(state === 'saving') { text.textContent = 'Salvando...'; text.className = 'status-saving'; }
            else if(state === 'saved') { text.textContent = 'Online'; text.className = 'status-saved'; }
            else { text.textContent = 'Erro'; text.className = 'status-error'; }
        }

        async function loadFromCloud() {
            try {
                const docSnap = await getDoc(doc(db, "users", "dante_data"));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    store = JSON.parse(data.store_json);
                    store.date = new Date(store.date || new Date());
                }
            } catch (e) { console.error(e); setStatus('error'); }
        }

        async function saveToCloud() {
            setStatus('saving');
            try {
                await setDoc(doc(db, "users", "dante_data"), { store_json: JSON.stringify(store), last_update: new Date() });
                setStatus('saved');
            } catch (e) { setStatus('error'); }
        }

        async function init() {
            lucide.createIcons();
            try {
                // Safety timeout
                const loadPromise = loadFromCloud();
                const timeoutPromise = new Promise(resolve => setTimeout(resolve, 2000));
                await Promise.race([loadPromise, timeoutPromise]);
            } catch (e) {} 
            
            if (!store.activeId) {
                const defaultId = 'acc_' + Date.now();
                store.activeId = defaultId;
                store.accounts = {};
                store.accounts[defaultId] = { id: defaultId, name: 'Conta Principal', size: '50k', monthType: 1, data: {}, payouts: [] };
                saveToCloud(); 
            }
            renderSidebar(); loadAccount(store.activeId); 
            els.loader.classList.add('opacity-0');
            setTimeout(() => els.loader.classList.add('hidden'), 500);
            setStatus('saved'); document.getElementById('status-text').textContent = "Online";
            setupListeners();
            
            window.updateData = updateData; window.printReport = printReport; window.shareReport = shareReport; window.filterReport = filterReport;
        }

        function setupListeners() {
            document.getElementById('open-sidebar').onclick = toggleSidebar; document.getElementById('close-sidebar').onclick = toggleSidebar; els.backdrop.onclick = toggleSidebar;
            document.getElementById('add-account-btn').onclick = createAccount; document.getElementById('rename-account-btn').onclick = renameAccount;
            els.inpSize.onchange = updateConfig; els.inpMonth.onchange = updateConfig;
            document.getElementById('prev-month').onclick = () => changeMonth(-1); document.getElementById('next-month').onclick = () => changeMonth(1);
        }

        init();
    </script>
</body>
</html>