<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex Enterprise - DF Strategic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; overflow-x: hidden; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .text-profit { color: #16a34a; }
        .text-loss { color: #dc2626; }
        
        .dashboard-card {
            background: white; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
        }
        
        .result-input { font-weight: 600; transition: all 0.2s; padding-left: 1.2rem; }
        .result-input:focus { transform: scale(1.01); outline: none; border-color: #6366f1; }

        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0); }
        .sidebar-closed { transform: translateX(-100%); }
        
        /* Status Cloud */
        #cloud-status { transition: all 0.5s; }
        .status-saved { color: #16a34a; } .status-saving { color: #f59e0b; } .status-error { color: #dc2626; }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 20px; }
            #sidebar, #header-main, .no-print { display: none !important; }
        }

        .account-item:hover { background-color: #334155; }
        .account-item.active { background-color: #4f46e5; border-left: 4px solid #818cf8; }
    </style>
</head>
<body class="pb-12">

    <div id="app-loader" class="fixed inset-0 bg-slate-900 z-[9999] flex flex-col items-center justify-center text-white">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mb-4"></div>
        <p class="text-sm animate-pulse">Conectando ao Banco de Dados...</p>
    </div>

    <div id="print-area" class="hidden"></div>

    <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden backdrop-blur-sm transition-opacity no-print"></div>
    <div id="sidebar" class="fixed inset-y-0 left-0 w-80 bg-slate-900 text-white z-50 sidebar-closed shadow-2xl flex flex-col no-print">
        <div class="p-5 border-b border-slate-700 flex justify-between items-center">
            <div>
                <h2 class="font-bold text-xl">Minhas Contas</h2>
                <p class="text-xs text-slate-400">Gerenciamento Multi-PA</p>
            </div>
            <button id="close-sidebar" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-2" id="account-list"></div>
        <div class="p-4 border-t border-slate-700 bg-slate-800">
            <button id="add-account-btn" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-sm font-bold flex items-center justify-center gap-2 transition">
                <i data-lucide="plus-circle" class="w-4 h-4"></i> Nova Conta
            </button>
        </div>
    </div>

    <div id="header-main" class="bg-slate-900 text-white py-2 px-4 shadow-md sticky top-0 z-40 flex justify-between items-center no-print">
        <div class="flex items-center gap-3">
            <button id="open-sidebar" class="p-1 hover:bg-slate-700 rounded text-slate-300"><i data-lucide="menu" class="w-6 h-6"></i></button>
            <div class="flex items-center gap-2">
                <div class="bg-indigo-500 p-1 rounded"><i data-lucide="bar-chart-2" class="w-4 h-4"></i></div>
                <span class="font-bold tracking-wide text-sm md:text-base">Apex Enterprise <span class="font-normal text-slate-400">| DF Strategic</span></span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div id="cloud-status" class="text-xs flex items-center gap-1 text-slate-400 font-medium">
                <i data-lucide="cloud" class="w-3 h-3"></i> <span id="status-text">Conectando...</span>
            </div>
        </div>
    </div>

    <div class="bg-white border-b border-slate-200 shadow-sm sticky top-10 z-30 no-print">
        <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center gap-3">
            <div>
                <h1 id="active-account-name" class="font-bold text-lg leading-none text-slate-800">Carregando...</h1>
                <p class="text-xs text-slate-500 flex items-center gap-1 mt-1"><span id="active-account-config">--</span></p>
            </div>
            <div class="flex gap-2 text-sm">
                <select id="config-size" class="bg-slate-50 border border-slate-300 rounded px-2 py-1 text-slate-700 text-xs focus:ring-indigo-500 outline-none">
                    <option value="25k">25k</option><option value="50k">50k</option><option value="75k">75k</option>
                    <option value="100k">100k</option><option value="150k">150k</option><option value="250k">250k</option><option value="300k">300k</option>
                </select>
                <select id="config-month" class="bg-slate-50 border border-slate-300 rounded px-2 py-1 text-slate-700 text-xs outline-none">
                    <option value="1">Mês 1-3 (Limitado)</option><option value="4">Mês 4+ (Livre)</option>
                </select>
                <button id="rename-account-btn" class="p-1.5 bg-slate-100 hover:bg-indigo-100 text-slate-500 hover:text-indigo-600 rounded transition" title="Renomear Conta"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6 space-y-6 no-print">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="dashboard-card p-4 border-l-4 border-l-indigo-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Saldo Atual (Equity)</p>
                <h2 id="current-equity" class="text-3xl font-extrabold text-slate-800 mt-1">$0.00</h2>
                <p id="equity-diff" class="text-xs font-medium mt-1 text-gray-500">--</p>
            </div>
            <div class="dashboard-card p-4 border-l-4 border-l-green-500 relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div><p class="text-xs font-bold text-green-900 uppercase flex items-center gap-1"><i data-lucide="target" class="w-3 h-3"></i> Teto 30% (Hoje)</p><h2 id="gain-cap" class="text-2xl font-bold text-green-600 mt-1">$0.00</h2></div>
                </div>
                <p class="text-xs text-gray-500 mt-1">Limite sugerido p/ consistência.</p>
            </div>
             <div class="dashboard-card p-4 border-l-4 border-l-yellow-500">
                <p class="text-xs font-bold text-yellow-700 uppercase">Saque</p>
                <div class="flex items-center justify-between mt-2"><span id="payout-status" class="text-lg font-bold text-slate-700">Analisando...</span></div>
                <p id="payout-msg" class="text-xs text-slate-400 mt-1">--</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                    <button id="prev-month" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="chevron-left"></i></button>
                    <h2 id="calendar-title" class="text-xl font-bold text-slate-700">--</h2>
                    <button id="next-month" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="chevron-right"></i></button>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3">Data</th>
                                    <th class="px-4 py-3 w-32">Resultado</th>
                                    <th class="px-4 py-3">Notas</th>
                                    <th class="px-4 py-3 text-center w-10" title="Marcar como Folga/Feriado"><i data-lucide="coffee" class="w-3 h-3 mx-auto"></i></th>
                                    <th class="px-4 py-3 text-center w-10" title="Marcar como Sacado"><i data-lucide="check-circle-2" class="w-3 h-3 mx-auto text-green-600"></i></th>
                                </tr>
                            </thead>
                            <tbody id="calendar-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-4">
                <div class="dashboard-card p-5">
                    <h3 class="font-bold text-slate-800 mb-4 text-sm uppercase tracking-wide flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-4 h-4"></i> Performance (Dias Operados)
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center border-b border-slate-50 pb-1">
                            <span class="text-slate-500">Últimos 10 Dias</span>
                            <span id="stats-10" class="font-bold text-slate-700">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-slate-50 pb-1">
                            <span class="text-slate-500">Últimos 20 Dias</span>
                            <span id="stats-20" class="font-bold text-slate-700">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-slate-50 pb-1">
                            <span class="text-slate-500">Últimos 30 Dias</span>
                            <span id="stats-30" class="font-bold text-slate-700">$0.00</span>
                        </div>
                        
                        <div class="mt-4 pt-2 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-semibold text-indigo-400 uppercase">Média Diária (11d)</span>
                                <span id="stats-avg" class="font-bold text-indigo-600">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-bold text-indigo-800 uppercase">Projeção (22 dias)</span>
                                <span id="stats-proj" class="font-bold text-lg text-indigo-700">$0.00</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-2 mt-2">
                            <span class="font-bold text-slate-600">Total Mês Atual</span>
                            <span id="stats-month" class="font-bold text-slate-800">$0.00</span>
                        </div>
                    </div>
                    <div id="weekly-list" class="mt-4 space-y-1 text-xs text-slate-500"></div>
                </div>

                <div class="dashboard-card p-5 bg-slate-900 text-white border-none">
                    <h3 class="font-bold text-sm mb-3 text-slate-200">Regras & Saque</h3>
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1 text-slate-400"><span>Rede Segurança</span><span id="safety-target">--</span></div>
                        <div class="bg-slate-700 h-2 rounded-full overflow-hidden"><div id="safety-bar" class="bg-green-500 h-full transition-all" style="width: 0%"></div></div>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between text-xs mb-1 text-slate-400"><span>Consistência (Max 30%)</span><span id="cons-ratio">0%</span></div>
                        <div class="bg-slate-700 h-2 rounded-full overflow-hidden"><div id="cons-bar" class="bg-indigo-500 h-full transition-all" style="width: 0%"></div></div>
                    </div>
                    <button id="btn-payout" disabled class="w-full py-2 rounded bg-slate-700 text-slate-500 font-bold text-sm flex justify-center items-center gap-2"><i data-lucide="lock" class="w-4 h-4"></i> Indisponível</button>
                </div>

                <div class="dashboard-card p-5">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2"><i data-lucide="history" class="w-4 h-4"></i> Histórico</h3>
                        <button onclick="printReport()" class="text-xs bg-slate-100 hover:bg-slate-200 text-indigo-600 px-2 py-1 rounded flex items-center gap-1"><i data-lucide="printer" class="w-3 h-3"></i> Relatório</button>
                    </div>
                    <div class="max-h-40 overflow-y-auto text-sm space-y-2" id="payout-history"><p class="text-xs text-slate-400 italic">Nenhum saque nesta conta.</p></div>
                    <div class="pt-2 mt-2 border-t border-slate-100 flex justify-between text-xs font-bold"><span>Total Sacado:</span><span id="total-withdrawn" class="text-green-600">$0.00</span></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. IMPORT FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. CONFIGURAÇÃO FIREBASE (JÁ CONFIGURADO)
        const firebaseConfig = {
            apiKey: "AIzaSyCu5pQrMnrpSj45lto_GXKx9xIWq2kyDjg",
            authDomain: "df-apex-manager.firebaseapp.com",
            projectId: "df-apex-manager",
            storageBucket: "df-apex-manager.firebasestorage.app",
            messagingSenderId: "761037562102",
            appId: "1:761037562102:web:a7622dca93a157dc21ccd7"
        };

        // 3. INICIALIZAÇÃO
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase Conectado!");
        } catch (e) {
            console.error("Erro Firebase:", e);
            alert("Erro na configuração do Firebase. Verifique o código.");
        }

        const RULES = {
            '25k': { start: 25000, drawdown: 1500, safetyThreshold: 26600, payouts: [1500, 1500, 1500] },
            '50k': { start: 50000, drawdown: 2500, safetyThreshold: 52600, payouts: [2000, 2000, 2000] },
            '75k': { start: 75000, drawdown: 2750, safetyThreshold: 77850, payouts: [2250, 2250, 2250] },
            '100k': { start: 100000, drawdown: 3000, safetyThreshold: 103100, payouts: [2500, 2500, 2500] },
            '150k': { start: 150000, drawdown: 5000, safetyThreshold: 155100, payouts: [2750, 2750, 2750] },
            '250k': { start: 250000, drawdown: 6500, safetyThreshold: 256600, payouts: [3000, 3000, 3000] },
            '300k': { start: 300000, drawdown: 7500, safetyThreshold: 307600, payouts: [3000, 3000, 3000] }
        };

        let store = { activeId: null, date: new Date(), accounts: {} };
        let saveTimeout;

        // Elementos DOM
        const els = { 
            sidebar: document.getElementById('sidebar'), backdrop: document.getElementById('sidebar-backdrop'), accList: document.getElementById('account-list'), 
            activeName: document.getElementById('active-account-name'), activeConfig: document.getElementById('active-account-config'), 
            inpSize: document.getElementById('config-size'), inpMonth: document.getElementById('config-month'), 
            equity: document.getElementById('current-equity'), equityDiff: document.getElementById('equity-diff'), 
            gainCap: document.getElementById('gain-cap'), 
            stats10: document.getElementById('stats-10'), stats20: document.getElementById('stats-20'), stats30: document.getElementById('stats-30'), 
            statsMonth: document.getElementById('stats-month'), statsAvg: document.getElementById('stats-avg'), statsProj: document.getElementById('stats-proj'),
            weeklyList: document.getElementById('weekly-list'), 
            calendarTitle: document.getElementById('calendar-title'), calendarBody: document.getElementById('calendar-body'), 
            safetyBar: document.getElementById('safety-bar'), safetyTarget: document.getElementById('safety-target'), 
            consBar: document.getElementById('cons-bar'), consRatio: document.getElementById('cons-ratio'), 
            payoutStatus: document.getElementById('payout-status'), payoutMsg: document.getElementById('payout-msg'), btnPayout: document.getElementById('btn-payout'), 
            payoutHistory: document.getElementById('payout-history'), totalWithdrawn: document.getElementById('total-withdrawn'), 
            printArea: document.getElementById('print-area'), loader: document.getElementById('app-loader'), cloudStatus: document.getElementById('status-text') 
        };

        // --- CORE LOGIC COM FIREBASE ---

        async function init() {
            lucide.createIcons();
            await loadFromCloud(); 
            
            if (!store.activeId) {
                const defaultId = 'acc_' + Date.now();
                store.activeId = defaultId;
                store.accounts = {};
                store.accounts[defaultId] = { id: defaultId, name: 'Conta Principal', size: '50k', monthType: 1, data: {}, payouts: [] };
                saveToCloud(); 
            }

            renderSidebar();
            loadAccount(store.activeId);
            els.loader.classList.add('hidden');
            
            // --- CORREÇÃO VISUAL: Força o status "Online" ao carregar ---
            setStatus('saved'); 
            document.getElementById('status-text').textContent = "Online"; 

            // Listeners
            document.getElementById('open-sidebar').onclick = toggleSidebar;
            document.getElementById('close-sidebar').onclick = toggleSidebar;
            els.backdrop.onclick = toggleSidebar;
            document.getElementById('add-account-btn').onclick = createAccount;
            document.getElementById('rename-account-btn').onclick = renameAccount;
            els.inpSize.onchange = updateConfig;
            els.inpMonth.onchange = updateConfig;
            document.getElementById('prev-month').onclick = () => changeMonth(-1);
            document.getElementById('next-month').onclick = () => changeMonth(1);
            window.printReport = printReport;
        }

        // --- CLOUD FUNCTIONS ---
        async function loadFromCloud() {
            try {
                const docRef = doc(db, "users", "dante_data"); 
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    store = JSON.parse(data.store_json);
                    store.date = new Date(store.date || new Date()); 
                }
            } catch (e) {
                console.error("Erro ao carregar:", e);
                setStatus('error');
            }
        }

        async function saveToCloud() {
            setStatus('saving');
            try {
                await setDoc(doc(db, "users", "dante_data"), {
                    store_json: JSON.stringify(store),
                    last_update: new Date()
                });
                setStatus('saved');
            } catch (e) {
                console.error("Erro ao salvar:", e);
                setStatus('error');
            }
        }

        function setStatus(state) {
            const text = document.getElementById('status-text');
            if(state === 'saving') { text.textContent = 'Salvando...'; text.className = 'status-saving'; }
            else if(state === 'saved') { text.textContent = 'Salvo'; text.className = 'status-saved'; }
            else { text.textContent = 'Erro Sync'; text.className = 'status-error'; }
        }

        // --- HANDLERS ---
        
        window.updateData = function(iso, field, val) {
            const acc = getActive();
            if (!acc.data[iso]) acc.data[iso] = {};
            if (field === 'val') val = parseFloat(val) || 0;
            acc.data[iso][field] = val;
            renderDashboard();
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveToCloud, 1000); 
        };

        function createAccount() { 
            const name = prompt("Nome:"); if(!name)return; 
            const id = 'acc_' + Date.now(); 
            store.accounts[id] = { id, name, size: '50k', monthType: 1, data: {}, payouts: [] }; 
            saveToCloud(); renderSidebar(); loadAccount(id); toggleSidebar(); 
        }

        function renameAccount() { 
            const acc = getActive(); const newName = prompt("Nome:", acc.name); 
            if(newName){ acc.name = newName; saveToCloud(); renderSidebar(); els.activeName.textContent = newName; } 
        }

        function loadAccount(id) {
            if (!store.accounts[id]) id = Object.keys(store.accounts)[0];
            store.activeId = id; const acc = store.accounts[id];
            els.activeName.textContent = acc.name;
            els.activeConfig.textContent = `${acc.size} • Mês ${acc.monthType}`;
            els.inpSize.value = acc.size; els.inpMonth.value = acc.monthType;
            renderSidebar(); renderDashboard();
        }

        function updateConfig() {
            const acc = getActive(); acc.size = els.inpSize.value; acc.monthType = parseInt(els.inpMonth.value);
            saveToCloud(); els.activeConfig.textContent = `${acc.size} • Mês ${acc.monthType}`; renderDashboard();
        }

        function executePayout(v) {
            const note = prompt(`Valor: ${formatCurrency(v)}\n\nRef (Opcional):`);
            if(note === null) return;
            const acc = getActive(); acc.payouts.push({date:new Date().toISOString(), amount:v, note: note||''});
            saveToCloud(); renderDashboard(); alert("Saque salvo na nuvem!");
        }

        // --- RENDER & LOGIC ---
        function toggleSidebar() { const isOpen=!els.sidebar.classList.contains('sidebar-closed'); if(isOpen){els.sidebar.classList.add('sidebar-closed');els.sidebar.classList.remove('sidebar-open');els.backdrop.classList.add('hidden');}else{els.sidebar.classList.remove('sidebar-closed');els.sidebar.classList.add('sidebar-open');els.backdrop.classList.remove('hidden');} }
        function renderSidebar() { els.accList.innerHTML=''; Object.values(store.accounts).forEach(acc=>{ const stats=calculateStats(acc); const div=document.createElement('div'); div.className=`account-item p-3 rounded-lg cursor-pointer transition-colors mb-2 ${acc.id===store.activeId?'active':'bg-slate-800'}`; div.onclick=()=>{loadAccount(acc.id);toggleSidebar();}; div.innerHTML=`<div class="flex justify-between items-center"><span class="font-bold text-sm text-slate-200">${acc.name}</span><span class="text-xs text-indigo-300 font-mono">${acc.size}</span></div><div class="flex justify-between items-center mt-1"><span class="text-xs text-slate-400">Saldo:</span><span class="text-xs font-bold ${stats.currentEquity>=RULES[acc.size].start?'text-green-400':'text-red-400'}">${formatCurrency(stats.currentEquity)}</span></div>`; els.accList.appendChild(div); }); }
        
        function renderDashboard() { 
            const acc=getActive(); const rules=RULES[acc.size]; const stats=calculateStats(acc); 
            els.equity.textContent=formatCurrency(stats.currentEquity); const diff=stats.currentEquity-rules.start; els.equityDiff.textContent=`Lucro: ${formatCurrency(diff)}`; els.equityDiff.className=diff>=0?"text-xs font-medium mt-1 text-green-600":"text-xs font-medium mt-1 text-red-500"; 
            
            // Risk card logic removed from rendering
            
            let gainCap=(stats.totalProfit>0)?(stats.totalProfit*0.30)/0.70:0; els.gainCap.textContent=gainCap>0?formatCurrency(gainCap):"Fazer Gordura"; 
            
            renderCalendar(acc); 
            
            // Stats
            els.stats10.textContent=formatCurrency(calcPeriod(acc,10)); 
            els.stats20.textContent=formatCurrency(calcPeriod(acc,20)); 
            els.stats30.textContent=formatCurrency(calcPeriod(acc,30));
            const proj = calcProjection(acc);
            els.statsAvg.textContent = formatCurrency(proj.avg);
            els.statsProj.textContent = formatCurrency(proj.projection);
            
            const mData=getMonthlyDataFixed(acc); els.statsMonth.textContent=formatCurrency(mData.total); els.weeklyList.innerHTML=mData.html; 
            
            els.safetyTarget.textContent=formatCurrency(rules.safetyThreshold); const distSafety=rules.safetyThreshold-stats.currentEquity; if(distSafety<=0){els.safetyBar.style.width='100%';els.safetyBar.classList.replace('bg-indigo-500','bg-green-500');} else {const pct=Math.max(0,Math.min(100,((stats.currentEquity-rules.start)/(rules.safetyThreshold-rules.start))*100));els.safetyBar.style.width=`${pct}%`;} 
            const ratio=stats.totalProfit>0?(stats.maxDay/stats.totalProfit)*100:0; els.consRatio.textContent=`${ratio.toFixed(1)}%`; els.consBar.style.width=`${Math.min(100,ratio)}%`; els.consBar.className=ratio>30?"h-full bg-red-500":"h-full bg-indigo-500"; 
            checkPayoutStatus(acc,stats,rules,ratio,distSafety); renderPayoutHistory(acc); lucide.createIcons(); 
        }
        
        function renderCalendar(acc) { 
            const y=store.date.getFullYear(); const m=store.date.getMonth(); els.calendarTitle.textContent=`${['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'][m]} ${y}`; els.calendarBody.innerHTML=''; const daysInMonth=new Date(y,m+1,0).getDate(); 
            for(let d=1;d<=daysInMonth;d++){ 
                const date=new Date(y,m,d); const iso=date.toISOString().split('T')[0]; const entry=acc.data[iso]||{val:0,note:'',holiday:false,withdrawn:false}; const isW=date.getDay()===0||date.getDay()===6; const tr=document.createElement('tr'); if(isW)tr.className="bg-slate-50 opacity-50"; if(entry.withdrawn)tr.className="bg-green-50"; 
                
                tr.innerHTML=`
                    <td class="px-4 py-2 font-medium text-slate-600">${d}</td>
                    <td class="px-4 py-2 relative">
                        <div class="relative w-full">
                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400 text-sm font-bold z-10 pointer-events-none select-none">$</span>
                            <input type="number" class="result-input w-full pl-6 pr-2 py-1 bg-transparent border-b border-transparent focus:border-indigo-500 text-slate-800 ${entry.val>0?'text-green-600':(entry.val<0?'text-red-600':'')}" value="${entry.val!==0?entry.val.toFixed(2):''}" placeholder="0.00" onchange="updateData('${iso}','val',this.value)" ${isW?'disabled':''}>
                        </div>
                    </td>
                    <td class="px-4 py-2"><input type="text" class="w-full bg-transparent text-xs" value="${entry.note||''}" placeholder="..." onchange="updateData('${iso}','note',this.value)" ${isW?'disabled':''}></td>
                    <td class="px-4 py-2 text-center"><input type="checkbox" ${entry.holiday?'checked':''} onchange="updateData('${iso}','holiday',this.checked)" ${isW?'disabled':''} title="Feriado/Folga (Não conta)"></td>
                    <td class="px-4 py-2 text-center"><input type="checkbox" class="accent-green-600" ${entry.withdrawn?'checked':''} onchange="updateData('${iso}','withdrawn',this.checked)" ${isW?'disabled':''} title="Saque realizado"></td>
                `;
                els.calendarBody.appendChild(tr);
            } 
        }
        
        function getMonthlyDataFixed(acc) { const y = store.date.getFullYear(); const m = store.date.getMonth(); const daysInMonth = new Date(y, m+1, 0).getDate(); let weeks = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }; let total = 0; for(let d=1; d<=daysInMonth; d++) { const date = new Date(y, m, d); const iso = date.toISOString().split('T')[0]; const entry = acc.data[iso]; const weekIndex = Math.ceil(d / 7); if(entry && !entry.holiday) { weeks[weekIndex] += (entry.val || 0); total += (entry.val || 0); } } let html = ''; for(let i=1; i<=5; i++) { const startDay = (i - 1) * 7 + 1; if (startDay > daysInMonth) continue; const label = `Semana ${i} (${startDay < 10 ? '0'+startDay : startDay}/${m+1 < 10 ? '0'+(m+1) : m+1})`; const val = weeks[i]; html += `<div class="flex justify-between border-b border-slate-50 pb-1 last:border-0 text-xs"><span class="text-slate-500">${label}</span><span class="font-bold ${val >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(val)}</span></div>`; } if(!html) html = '<span class="italic text-xs text-slate-400">Sem dados</span>'; return { total, html }; }
        function calculateStats(acc) { const rules=RULES[acc.size]; let tp=0; let dt=0; let pe=rules.start; let md=0; const keys=Object.keys(acc.data).sort(); let re=rules.start; keys.forEach(d=>{ const e=acc.data[d]; const val = e.val || 0; if(val!==0 && !e.holiday){ tp+=val; dt++; re+=val; if(re>pe)pe=re; if(val>md)md=val; } }); const w=(acc.payouts||[]).reduce((s,p)=>s+p.amount,0); return {currentEquity:rules.start+tp-w, totalProfit:tp, daysTraded:dt, peakEquity:pe, maxDay:md}; }
        function checkPayoutStatus(acc,stats,rules,ratio,dist){ const d=stats.daysTraded>=8; const s=dist<=0; const c=ratio<=30; let avail=0; if(d&&s&&c) avail=Math.min(stats.currentEquity-rules.safetyThreshold, acc.monthType<=3?rules.payouts[0]:999999); if(avail>=500){ els.payoutStatus.textContent="Disponível"; els.payoutStatus.className="text-lg font-bold text-green-600"; els.payoutMsg.textContent=`Pode sacar ${formatCurrency(avail)}`; els.btnPayout.disabled=false; els.btnPayout.className="w-full py-2 rounded bg-green-600 hover:bg-green-700 text-white font-bold text-sm shadow transition flex justify-center items-center gap-2"; els.btnPayout.innerHTML=`<i data-lucide="dollar-sign" class="w-4 h-4"></i> Sacar ${formatCurrency(avail)}`; els.btnPayout.onclick=()=>executePayout(avail); } else { els.payoutStatus.textContent="Em Progresso"; els.payoutStatus.className="text-lg font-bold text-slate-700"; els.payoutMsg.textContent=!s?"Falta atingir a rede.":(!d?`Faltam ${8-stats.daysTraded} dias.`:(!c?"Ajustar consistência.":"Mínimo $500 excedente.")); els.btnPayout.disabled=true; els.btnPayout.className="w-full py-2 rounded bg-slate-700 text-slate-500 font-bold text-sm cursor-not-allowed flex justify-center items-center gap-2"; els.btnPayout.innerHTML=`<i data-lucide="lock" class="w-4 h-4"></i> Indisponível`; } }
        function renderPayoutHistory(acc){ els.payoutHistory.innerHTML='';let t=0; if(!acc.payouts||!acc.payouts.length) els.payoutHistory.innerHTML='<p class="text-xs text-slate-400 italic">Nenhum saque.</p>'; else { acc.payouts.slice().reverse().forEach(p=>{ t+=p.amount; const d=document.createElement('div'); d.className="border-b border-slate-50 pb-2 mb-2 last:border-0"; d.innerHTML=`<div class="flex justify-between items-center"><span class="text-xs text-slate-500">${new Date(p.date).toLocaleDateString()}</span><span class="font-bold text-green-600">${formatCurrency(p.amount)}</span></div>${p.note ? `<div class="text-xs text-slate-400 mt-0.5 italic">Ref: ${p.note}</div>` : ''}`; els.payoutHistory.appendChild(d); }); } els.totalWithdrawn.textContent=formatCurrency(t); }
        function printReport() { const acc = getActive(); let total = 0; let html = `<div style="font-family: sans-serif; max-width: 800px; margin: 0 auto;"><div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px;"><div><h1 style="margin:0; color:#0f172a;">Relatório de Saques</h1><p style="margin:5px 0 0; color:#64748b;">Apex Cloud | DF Strategic</p></div><div style="text-align:right;"><h3 style="margin:0;">${acc.name}</h3><p style="margin:0; color:#64748b;">${acc.size} • ${new Date().toLocaleDateString()}</p></div></div><table style="width:100%; border-collapse: collapse; margin-bottom: 30px;"><thead><tr style="background-color: #f1f5f9; text-align:left;"><th style="padding: 12px; border-bottom: 1px solid #cbd5e1;">Data</th><th style="padding: 12px; border-bottom: 1px solid #cbd5e1;">Referência / Período</th><th style="padding: 12px; border-bottom: 1px solid #cbd5e1; text-align:right;">Valor (USD)</th></tr></thead><tbody>`; if(acc.payouts && acc.payouts.length > 0) { acc.payouts.forEach(p => { total += p.amount; html += `<tr><td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${new Date(p.date).toLocaleDateString()}</td><td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${p.note || '-'}</td><td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align:right; font-weight:bold;">${formatCurrency(p.amount)}</td></tr>`; }); } else { html += `<tr><td colspan="3" style="padding:20px; text-align:center; color:#64748b;">Nenhum saque registrado.</td></tr>`; } html += `</tbody><tfoot><tr style="background-color: #f8fafc;"><td colspan="2" style="padding: 12px; text-align:right; font-weight:bold; color:#334155;">TOTAL SACADO:</td><td style="padding: 12px; text-align:right; font-weight:bold; color:#16a34a; font-size:1.1em;">${formatCurrency(total)}</td></tr></tfoot></table><div style="margin-top: 50px; text-align:center; font-size: 0.8em; color: #94a3b8;"><p>Gerado automaticamente pelo sistema Apex Cloud</p></div></div>`; const printArea = document.getElementById('print-area'); printArea.innerHTML = html; window.print(); }
        
        // --- LOGICA DE DIAS OPERADOS ---
        function getTradedDays(acc) {
            const allDates = Object.keys(acc.data);
            return allDates.filter(iso => {
                const entry = acc.data[iso];
                const val = entry.val || 0;
                return val !== 0 && !entry.holiday;
            }).sort((a, b) => new Date(b) - new Date(a));
        }

        function calcPeriod(acc, daysLimit) {
            const tradedDays = getTradedDays(acc);
            const recentDays = tradedDays.slice(0, daysLimit);
            let sum = 0;
            recentDays.forEach(iso => sum += (acc.data[iso].val || 0));
            return sum;
        }

        function calcProjection(acc) {
            const tradedDays = getTradedDays(acc);
            const last11Days = tradedDays.slice(0, 11);
            let sum = 0;
            last11Days.forEach(iso => sum += (acc.data[iso].val || 0));
            const count = last11Days.length;
            const avg = count > 0 ? sum / count : 0;
            const projection = avg * 22; 
            return { avg, projection };
        }

        function changeMonth(d){store.date.setMonth(store.date.getMonth()+d);renderDashboard();} 
        function getActive(){return store.accounts[store.activeId];} function formatCurrency(v){return v.toLocaleString('en-US',{style:'currency',currency:'USD'});}

        init();
    </script>
</body>
</html>